<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ParentData Email Staging Tool</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header>
  <h1>ParentData Email Staging Tool</h1>
  <p style="margin:4px 0 0;font-size:14px;color:#666;"><a href="/email-checker" style="color:#3b82f6;text-decoration:none;">One-off Email Checker</a></p>
</header>

<main>

  <!-- ── Choose Template ─────────────────────────────────────────────── -->
  <section id="section-template" class="card">
    <h2>Choose Template</h2>
    <div class="field-group" style="margin-bottom:0;">
      <select id="template-select" onchange="selectTemplate(this.value)">
        <option value="fertility">Fertility Article</option>
        <option value="fertility_digest">Fertility Digest</option>
        <option value="qa">Fertility Q&amp;A</option>
        <option value="standard" selected>Latest</option>
        <option value="latest_teaser">Latest Teaser</option>
        <option value="marketing">Marketing - Full Article Send</option>
        <option value="paid_digest">Paid Digest</option>
      </select>
    </div>
  </section>

  <!-- ── Step 1: Upload ──────────────────────────────────────────────── -->
  <section id="section-upload" class="card">
    <h2>1. Upload Article</h2>

    <!-- Standard / Fertility upload options -->
    <div id="standard-upload-area">
      <div id="docx-upload-row">
        <div class="upload-zone" id="upload-zone">
          <input type="file" id="file-input" accept=".docx" hidden>
          <p>Drag &amp; drop your <strong>.docx</strong> file here, or <button type="button" class="link-btn" id="browse-btn">browse</button></p>
          <p id="file-name" class="file-name"></p>
        </div>
      </div>

      <div class="upload-or" id="docx-gdoc-divider">— or —</div>

      <div id="gdoc-url-row">
        <div class="field-group" style="margin-bottom:0;">
          <label for="gdoc-url">Google Doc link</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="url" id="gdoc-url" placeholder="https://docs.google.com/document/d/…" style="flex:1;" onkeydown="if(event.key==='Enter') handleGoogleDocUrl()">
            <button type="button" class="btn-small" onclick="handleGoogleDocUrl()" style="padding:6px 16px;">Use this doc</button>
          </div>
          <p class="hint" style="margin-top:5px;">Doc must be shared as "Anyone with the link can view".</p>
        </div>
      </div>

      <div class="upload-or" id="wp-url-row-divider">— or —</div>

      <div id="wp-url-row" style="margin-bottom:0;">
        <div class="field-group" style="margin-bottom:0;">
          <label for="wp-url">ParentData article URL</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="url" id="wp-url" placeholder="https://parentdata.org/…" style="flex:1;" onkeydown="if(event.key==='Enter') handleWpUrl()">
            <button type="button" class="btn-small" onclick="handleWpUrl()" style="padding:6px 16px;">Use this article</button>
          </div>
          <p class="hint" style="margin-top:5px;">Pull from an already-published ParentData article.</p>
        </div>
      </div>
    </div>

    <!-- Q&A upload options (two URLs) -->
    <div id="qa-upload-area" style="display:none;">
      <p class="hint" style="margin-bottom:14px;">Paste the two ParentData Q&amp;A article URLs to fetch. Requires WP credentials in .env.</p>
      <div class="field-group">
        <label for="wp-url-1">Article 1 URL</label>
        <input type="url" id="wp-url-1" placeholder="https://parentdata.org/…">
      </div>
      <div class="field-group">
        <label for="wp-url-2">Article 2 URL</label>
        <input type="url" id="wp-url-2" placeholder="https://parentdata.org/…">
      </div>
      <div class="field-group" style="margin-bottom:0;">
        <label for="qa-intro-text">Intro text</label>
        <textarea id="qa-intro-text" rows="3" style="width:100%;" placeholder="It's Q&amp;A day! This week's questions are about…"></textarea>
      </div>
      <button type="button" class="btn-primary" onclick="handleQAUrls()" style="margin-top:16px;">Fetch Both Articles</button>
    </div>

    <div id="upload-status" class="status-bar" hidden></div>
  </section>

  <!-- ── Step 2: Extracted Fields (standard / fertility) ─────────────── -->
  <section id="section-fields" class="card" hidden>
    <h2>2. Review Extracted Fields</h2>

    <div class="field-group">
      <label for="f-title">Title</label>
      <input type="text" id="f-title" placeholder="Article title">
    </div>

    <div class="field-group">
      <label for="f-subtitle">Subtitle</label>
      <p class="hint">One line per subtitle row (press Enter for a new row).</p>
      <textarea id="f-subtitle" rows="2" placeholder="Subtitle line 1&#10;Subtitle line 2"></textarea>
    </div>

    <div id="group-welcome" class="field-group">
      <label for="f-welcome">Welcome Text (Emily's intro HTML)</label>
      <p class="hint">Full HTML including the &lt;hr&gt; at the end. Leave blank if Emily wrote the full article.</p>
      <textarea id="f-welcome" rows="8" class="code-area" placeholder="&lt;p style=&quot;...&quot;&gt;&lt;em&gt;Welcome to The Latest...&lt;/em&gt;&lt;/p&gt;&#10;&lt;hr&gt;"></textarea>
    </div>

    <div class="field-group">
      <label for="f-author-name">Author Name</label>
      <input type="text" id="f-author-name" placeholder="e.g. Gillian Goddard">
    </div>

    <div class="field-group">
      <label for="f-author-title">Author Title / Credential</label>
      <input type="text" id="f-author-title" placeholder="e.g. MD, Endocrinologist">
    </div>

    <div id="group-author-url" class="field-group">
      <label for="f-author-url">Author Page URL</label>
      <input type="url" id="f-author-url" placeholder="https://parentdata.org/author/…">
    </div>

    <div class="field-group">
      <label for="f-tags">Topic Tags</label>
      <input type="text" id="f-tags" placeholder="In the News, Hormones, Health and Wellness">
      <p class="hint">Comma-separated. Used to suggest related articles.</p>
    </div>

    <div id="group-marketing" style="display:none;">
      <div class="field-group">
        <label for="mkt-banner">Banner text</label>
        <input type="text" id="mkt-banner" value="It's the final day of your trial!">
      </div>
      <div class="field-group">
        <label for="mkt-intro">Intro text</label>
        <select id="mkt-intro"><option value="">— loading options —</option></select>
      </div>
      <div class="field-group">
        <label>Pricing plan</label>
        <div style="display:flex;gap:24px;padding:4px 0;">
          <label style="font-weight:400;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="radio" name="mkt-pricing-mode" id="mkt-mode-yearly" value="yearly" checked>
            Yearly&nbsp;(<s>$120</s>&nbsp;&rarr;&nbsp;$84/year)
          </label>
          <label style="font-weight:400;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="radio" name="mkt-pricing-mode" id="mkt-mode-monthly" value="monthly">
            Monthly&nbsp;(<s>$12</s>&nbsp;&rarr;&nbsp;$7/month)
          </label>
        </div>
      </div>
      <div class="field-group">
        <label for="mkt-price">Discount price</label>
        <input type="text" id="mkt-price" value="$84/year">
      </div>
      <div class="field-group">
        <label for="mkt-url">Discount URL</label>
        <input type="url" id="mkt-url" value="https://parentdata.org/register/plus-yearly/?coupon=allaccess30">
      </div>
    </div>
  </section>

  <!-- ── Step 3: Featured Image (standard / fertility) ────────────────── -->
  <section id="section-image" class="card" hidden>
    <h2>3. Featured Image</h2>

    <div class="field-group">
      <label for="f-img-url">Image URL (Iterable CDN)</label>
      <input type="url" id="f-img-url" placeholder="https://library.iterable.com/…">
    </div>

    <div class="field-group">
      <label for="f-img-alt">Image Alt Text</label>
      <input type="text" id="f-img-alt" placeholder="Brief description of the image">
    </div>
  </section>

  <!-- ── Step 4: Article Body HTML (standard / fertility) ─────────────── -->
  <section id="section-body" class="card" hidden>
    <h2>4. Article Body HTML</h2>
    <p class="hint">Claude-formatted HTML. Edit freely — this is what goes into the email.</p>
    <details>
      <summary>Show / hide article body</summary>
      <textarea id="f-body" rows="20" class="code-area" placeholder="Article body HTML will appear here after upload…"></textarea>
    </details>
  </section>

  <!-- ── Step 4b: Inline Graphs ──────────────────────────────────────── -->
  <section id="section-graphs" class="card" hidden>
    <h2>4b. Inline Graph Images</h2>
    <p class="hint">The document contains embedded charts or graphs. Paste the Iterable CDN URL for each one — they will be placed in the article body in order.</p>
    <div id="graph-fields"></div>
  </section>

  <!-- ── Step 4c: Bottom Line (fertility only) ────────────────────────── -->
  <section id="section-bottomline" class="card" hidden>
    <h2>4c. Bottom Line</h2>
    <p class="hint">The summary bullet points that appear in the purple box at the end of the email. Paste or edit the <code>&lt;ul&gt;...&lt;/ul&gt;</code> HTML below.</p>
    <textarea id="f-bottomline" rows="10" class="code-area" placeholder="&lt;ul style=&quot;...&quot;&gt;&#10;  &lt;li&gt;First key takeaway&lt;/li&gt;&#10;&lt;/ul&gt;"></textarea>
  </section>

  <!-- ── Step 2 (QA): Intro Text ──────────────────────────────────────── -->
  <section id="section-intro" class="card" hidden>
    <h2>2. Intro Text</h2>
    <p class="hint">Claude's suggested intro sentence. Edit freely before generating.</p>
    <textarea id="f-intro" rows="3" style="width:100%;" placeholder="It's Q&amp;A day! This week's questions are about…"></textarea>
  </section>

  <!-- ── Step 3 (QA): Q&A Pair 1 ─────────────────────────────────────── -->
  <section id="section-qa1" class="card" hidden>
    <h2>3. Question &amp; Answer 1</h2>

    <div class="field-group">
      <label for="qa1-question">Question Text</label>
      <p class="hint">The reader's question as plain text (no HTML).</p>
      <textarea id="qa1-question" rows="4" placeholder="I'm coming off birth control and haven't had a period yet…"></textarea>
    </div>

    <div class="field-group">
      <label for="qa1-author">Sign-off Name</label>
      <input type="text" id="qa1-author" placeholder="e.g. Anne Marie">
    </div>

    <div class="field-group">
      <label for="qa1-answer">Answer HTML</label>
      <details>
        <summary>Show / hide answer body</summary>
        <textarea id="qa1-answer" rows="16" class="code-area" placeholder="Answer HTML will appear here after fetch…"></textarea>
      </details>
    </div>
  </section>

  <!-- ── Step 4 (QA): Q&A Pair 2 ─────────────────────────────────────── -->
  <section id="section-qa2" class="card" hidden>
    <h2>4. Question &amp; Answer 2</h2>

    <div class="field-group">
      <label for="qa2-question">Question Text</label>
      <p class="hint">The reader's question as plain text (no HTML).</p>
      <textarea id="qa2-question" rows="4" placeholder="How early should I start taking prenatal vitamins?"></textarea>
    </div>

    <div class="field-group">
      <label for="qa2-author">Sign-off Name</label>
      <input type="text" id="qa2-author" placeholder="e.g. Another pill to swallow">
    </div>

    <div class="field-group">
      <label for="qa2-answer">Answer HTML</label>
      <details>
        <summary>Show / hide answer body</summary>
        <textarea id="qa2-answer" rows="16" class="code-area" placeholder="Answer HTML will appear here after fetch…"></textarea>
      </details>
    </div>

    <div class="field-group" style="margin-top:8px;">
      <label for="qa-author-line">Author attribution line</label>
      <p class="hint">Appears at the bottom of the email in italic. Edit freely.</p>
      <input type="text" id="qa-author-line" placeholder="Today&#8217;s answers come from Emily Oster and Nathan Fox.">
    </div>
  </section>

  <!-- ── Step 5: Related Articles (standard only) ─────────────────────── -->
  <section id="section-related" class="card" hidden>
    <h2>5. Related Reading</h2>
    <p class="hint">Articles are scored from the full ParentData archive. Swap or edit as needed.</p>

    <div id="related-cache-info" class="hint" style="margin-bottom:10px;"></div>
    <div id="related-loading" class="status-bar" hidden>Fetching article suggestions…</div>

    <div class="related-grid">
      <div class="related-slot" id="slot-0">
        <h3>Article 1</h3>
        <div class="swap-row">
          <label>Swap with:</label>
          <select id="swap-0"><option value="">— select —</option></select>
          <button type="button" class="btn-small" onclick="applySwap(0)">Apply</button>
        </div>
        <div class="field-group image-url-field">
          <label>Image URL <span class="required">*</span></label>
          <input type="url" id="rel-0-image-url" placeholder="https://library.iterable.com/…">
        </div>
        <div class="field-group">
          <label>Image Alt</label>
          <input type="text" id="rel-0-image-alt" placeholder="Brief image description">
        </div>
        <div class="field-group">
          <label>Title</label>
          <input type="text" id="rel-0-title">
        </div>
        <div class="field-group">
          <label>URL</label>
          <input type="url" id="rel-0-url">
        </div>
        <div class="field-group">
          <label>Tagline <span class="field-note">— keep to one short line</span></label>
          <input type="text" id="rel-0-description" maxlength="80" placeholder="e.g. Q&amp;A on getting an appointment">
        </div>
      </div>

      <div class="related-slot" id="slot-1">
        <h3>Article 2</h3>
        <div class="swap-row">
          <label>Swap with:</label>
          <select id="swap-1"><option value="">— select —</option></select>
          <button type="button" class="btn-small" onclick="applySwap(1)">Apply</button>
        </div>
        <div class="field-group image-url-field">
          <label>Image URL <span class="required">*</span></label>
          <input type="url" id="rel-1-image-url" placeholder="https://library.iterable.com/…">
        </div>
        <div class="field-group">
          <label>Image Alt</label>
          <input type="text" id="rel-1-image-alt" placeholder="Brief image description">
        </div>
        <div class="field-group">
          <label>Title</label>
          <input type="text" id="rel-1-title">
        </div>
        <div class="field-group">
          <label>URL</label>
          <input type="url" id="rel-1-url">
        </div>
        <div class="field-group">
          <label>Tagline <span class="field-note">— keep to one short line</span></label>
          <input type="text" id="rel-1-description" maxlength="80" placeholder="e.g. How pregnancy hormones affect blood sugar">
        </div>
      </div>
    </div>
  </section>

  <!-- ── Step 2 (Digest): Extracted Fields ───────────────────────────── -->
  <section id="section-digest" class="card" hidden>
    <h2>2. Review Digest Fields</h2>

    <div class="field-group">
      <label for="digest-title">Email Title</label>
      <input type="text" id="digest-title" placeholder="e.g. Choosing a donor or surrogate">
    </div>

    <div class="field-group">
      <label for="digest-intro">Intro Text</label>
      <textarea id="digest-intro" rows="3" style="width:100%;" placeholder="Editorial intro paragraph…"></textarea>
    </div>

    <div id="digest-cards"></div>
  </section>

  <!-- ── Step 2 (Latest Teaser): All fields ──────────────────────────── -->
  <section id="section-latest-teaser" class="card" hidden>
    <h2>2. Review Latest Teaser Fields</h2>

    <div class="field-group">
      <label for="lt-title">Title</label>
      <input type="text" id="lt-title" placeholder="Article title">
    </div>

    <div class="field-group">
      <label for="lt-subtitle">Subtitle</label>
      <p class="hint">One line per subtitle row (press Enter for a new row).</p>
      <textarea id="lt-subtitle" rows="2" placeholder="Subtitle line 1&#10;Subtitle line 2"></textarea>
    </div>

    <div class="field-group">
      <label for="lt-intro">Intro Text</label>
      <p class="hint">Emily's editorial intro paragraph(s) — plain text from the Google Doc.</p>
      <textarea id="lt-intro" rows="4" style="width:100%;" placeholder="This week, I want to talk about…"></textarea>
    </div>

    <div class="field-group">
      <label for="lt-fade-from">Fade From</label>
      <p class="hint">First words of the paragraph where greying begins (e.g. "Finally, there is the evolutionary").</p>
      <input type="text" id="lt-fade-from" placeholder="First words of the paragraph where greying starts">
    </div>

    <div class="field-group image-url-field">
      <label for="lt-img-url">Featured Image URL <span style="font-weight:400;color:#2a7a2a;">(auto-fetched)</span></label>
      <input type="url" id="lt-img-url" placeholder="https://parentdata.org/wp-content/uploads/…">
    </div>

    <div class="field-group">
      <label for="lt-img-alt">Featured Image Alt Text</label>
      <input type="text" id="lt-img-alt" placeholder="Brief description of the image">
    </div>

    <div class="field-group">
      <label>Article URL <span style="font-weight:400;">(from staging section)</span></label>
      <input type="url" id="lt-article-url" readonly style="background:#f5f5f5;color:#555;">
    </div>
  </section>

  <!-- ── Step 2 (Paid Digest): Extracted Fields ────────────────────── -->
  <section id="section-paid-digest" class="card" hidden>
    <h2>2. Review Paid Digest Fields</h2>
    <div id="paid-digest-sections"></div>
  </section>

  <!-- ── Generate ─────────────────────────────────────────────────────── -->
  <section id="section-generate" class="card" hidden>
    <h2>Generate Email</h2>
    <div id="group-update-banner" style="display:none; margin-bottom:14px;">
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
        <input type="checkbox" id="cb-update-banner">
        Include "Update your newsletters" banner at top
      </label>
    </div>
    <button type="button" id="generate-btn" class="btn-primary" onclick="generateEmail()">
      Generate Staged Email
    </button>
    <div id="generate-status" class="status-bar" hidden></div>
    <div id="result-links" hidden>
      <a id="preview-link" target="_blank" class="btn-secondary">Open Preview</a>
      <a id="download-link" download="staged_email.html" class="btn-secondary">Download HTML</a>
      <button type="button" class="btn-secondary" onclick="copyHtml()">Copy HTML</button>
    </div>
  </section>

</main>

<script>
// ── State ──────────────────────────────────────────────────────────────────
let currentTemplate = 'standard';
let allSuggestions = [];
let slotData = [{}, {}];
let lastGeneratedHtml = '';
let uploadedArticleUrl = '';
let ltArticleBodyHtml = '';
let _paidDigestStructure = [];  // [{articleCount: N}, ...] — tracks how many articles per section
const LT_DEFAULT_INTRO = "Today\u2019s featured article is a preview of what paid subscribers get every week \u2013 our most popular newsletter, The Latest.\n\nEver see a headline and wonder, \u201cShould I actually be worried about this?\u201d That\u2019s exactly what The Latest is for. Each week, Emily breaks down new research and trending headlines, separating what\u2019s worth paying attention to from what doesn\u2019t hold up in the data.\n\nThe Latest is included with a paid subscription so you can make decisions for your family based on evidence, not TikTok trends.";

// ── Template selection ──────────────────────────────────────────────────────
function selectTemplate(type) {
  currentTemplate = type;

  const isQA = type === 'qa';
  document.getElementById('standard-upload-area').style.display = isQA ? 'none' : '';
  document.getElementById('qa-upload-area').style.display = isQA ? '' : 'none';

  if (!isQA) {
    // Per-template input visibility:
    //   Latest (standard)      → Google Doc only
    //   Fertility Article      → ParentData URL only
    //   Marketing              → ParentData URL only
    //   Fertility Digest       → Google Doc only
    //   Latest Teaser          → DOCX + Google Doc
    //   (Q&A has its own area)
    const showDocx = type === 'latest_teaser';
    const showGdoc = type === 'standard' || type === 'fertility_digest' || type === 'latest_teaser' || type === 'paid_digest';
    const showWp   = type === 'fertility' || type === 'marketing';

    document.getElementById('docx-upload-row').style.display    = showDocx ? '' : 'none';
    document.getElementById('docx-gdoc-divider').style.display  = (showDocx && showGdoc) ? '' : 'none';
    document.getElementById('gdoc-url-row').style.display       = showGdoc ? '' : 'none';
    document.getElementById('wp-url-row-divider').style.display = 'none';
    document.getElementById('wp-url-row').style.display         = showWp ? '' : 'none';
  }
}

function _showPostUploadSections(isQA, isFertility, isMarketing, isDigest, isLatestTeaser, isPaidDigest) {
  // Digest, LatestTeaser, and PaidDigest have dedicated sections; hide all other post-upload sections
  const showStandardSections = !isQA && !isDigest && !isLatestTeaser && !isPaidDigest;

  // Sections common to standard + fertility + marketing
  ['section-fields', 'section-image', 'section-body', 'section-generate'].forEach(id => {
    document.getElementById(id).style.display = showStandardSections ? '' : 'none';
    if (showStandardSections) document.getElementById(id).removeAttribute('hidden');
  });

  // Standard-only related reading (also shown for latest_teaser)
  const showRelated = !isQA && !isFertility && !isMarketing && !isDigest && !isPaidDigest;
  document.getElementById('section-related').style.display = showRelated ? '' : 'none';
  if (showRelated) document.getElementById('section-related').removeAttribute('hidden');

  // Fertility-only
  document.getElementById('section-bottomline').style.display = isFertility ? '' : 'none';
  if (isFertility) document.getElementById('section-bottomline').removeAttribute('hidden');

  // QA-only
  ['section-qa1', 'section-qa2'].forEach(id => {
    document.getElementById(id).style.display = isQA ? '' : 'none';
    if (isQA) document.getElementById(id).removeAttribute('hidden');
  });
  // section-intro is no longer shown post-upload; intro text lives in the upload form
  document.getElementById('section-intro').style.display = 'none';

  // Digest-only
  document.getElementById('section-digest').style.display = isDigest ? '' : 'none';
  if (isDigest) document.getElementById('section-digest').removeAttribute('hidden');

  // Latest Teaser-only
  document.getElementById('section-latest-teaser').style.display = isLatestTeaser ? '' : 'none';
  if (isLatestTeaser) document.getElementById('section-latest-teaser').removeAttribute('hidden');

  // Paid Digest-only
  document.getElementById('section-paid-digest').style.display = isPaidDigest ? '' : 'none';
  if (isPaidDigest) document.getElementById('section-paid-digest').removeAttribute('hidden');

  // Always show generate
  const genSection = document.getElementById('section-generate');
  genSection.style.display = '';
  genSection.removeAttribute('hidden');

  // Field-level visibility within section-fields
  setHide('group-welcome', isFertility || isMarketing);
  setHide('group-author-url', isFertility || isMarketing);
  setHide('group-marketing', !isMarketing);

  // Fertility/QA-only option in generate section
  setHide('group-update-banner', !(isFertility || isQA));
}

function setHide(id, hide) {
  const el = document.getElementById(id);
  if (el) el.style.display = hide ? 'none' : '';
}

// ── Upload (standard / fertility) ───────────────────────────────────────────
document.getElementById('browse-btn').addEventListener('click', () => {
  document.getElementById('file-input').click();
});

document.getElementById('file-input').addEventListener('change', (e) => {
  if (e.target.files[0]) handleFile(e.target.files[0]);
});

const uploadZone = document.getElementById('upload-zone');
uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});

async function handleFile(file) {
  document.getElementById('file-name').textContent = file.name;
  showStatus('upload-status', 'Uploading and extracting fields with Claude… this may take 20–40 seconds.', 'info');
  const formData = new FormData();
  formData.append('file', file);
  formData.append('template_type', currentTemplate);
  await _submitUpload(formData);
}

async function handleGoogleDocUrl() {
  const url = document.getElementById('gdoc-url').value.trim();
  if (!url) return;
  document.getElementById('file-name').textContent = '';
  const digestMsg = (currentTemplate === 'fertility_digest' || currentTemplate === 'paid_digest')
    ? 'Downloading Google Doc, extracting article links, and fetching article metadata… this may take 30–60 seconds.'
    : 'Downloading Google Doc and extracting fields… this may take 20–40 seconds.';
  showStatus('upload-status', digestMsg, 'info');
  const formData = new FormData();
  formData.append('google_doc_url', url);
  formData.append('template_type', currentTemplate);
  await _submitUpload(formData);
}

async function handleWpUrl() {
  const url = document.getElementById('wp-url').value.trim();
  if (!url) return;
  document.getElementById('file-name').textContent = '';
  showStatus('upload-status', 'Fetching article from ParentData and reformatting with Claude… this may take 20–40 seconds.', 'info');
  const formData = new FormData();
  formData.append('wordpress_url', url);
  formData.append('template_type', currentTemplate);
  await _submitUpload(formData);
}

// ── Upload (QA) ──────────────────────────────────────────────────────────────
async function handleQAUrls() {
  const url1 = document.getElementById('wp-url-1').value.trim();
  const url2 = document.getElementById('wp-url-2').value.trim();
  if (!url1 || !url2) {
    showStatus('upload-status', 'Please enter both article URLs.', 'error');
    return;
  }
  showStatus('upload-status', 'Fetching both articles and extracting Q&A content… this may take 30–60 seconds.', 'info');
  const formData = new FormData();
  formData.append('wp_url_1', url1);
  formData.append('wp_url_2', url2);
  formData.append('template_type', 'qa');
  await _submitUpload(formData);
}

async function _submitUpload(formData) {
  try {
    const resp = await fetch('/upload', { method: 'POST', body: formData });
    const data = await resp.json();

    if (!resp.ok || data.error) {
      showStatus('upload-status', `Error: ${data.error || resp.statusText}`, 'error');
      return;
    }

    const isQA = currentTemplate === 'qa';
    const isFertility = currentTemplate === 'fertility';
    const isMarketing = currentTemplate === 'marketing';
    const isDigest = currentTemplate === 'fertility_digest';
    const isLatestTeaser = currentTemplate === 'latest_teaser';
    const isPaidDigest = currentTemplate === 'paid_digest';

    if (data.article_url) uploadedArticleUrl = data.article_url;

    if (isQA) {
      populateQAFields(data);
    } else if (isDigest) {
      populateDigestFields(data);
    } else if (isLatestTeaser) {
      populateLatestTeaserFields(data);
    } else if (isPaidDigest) {
      populatePaidDigestFields(data);
    } else {
      populateFields(data);

      if (data.graph_count > 0) {
        buildGraphFields(data.graph_count, data.inline_graphs || []);
        document.getElementById('section-graphs').removeAttribute('hidden');
      } else {
        document.getElementById('section-graphs').setAttribute('hidden', '');
      }

      if (!isFertility && !isMarketing) {
        fetchRelatedArticles(data.topic_tags || [], data.related_articles || []);
      }
    }

    _showPostUploadSections(isQA, isFertility, isMarketing, isDigest, isLatestTeaser, isPaidDigest);
    showStatus('upload-status', 'Fields extracted successfully.', 'success');

  } catch (err) {
    showStatus('upload-status', `Network error: ${err.message}`, 'error');
  }
}

function populateFields(data) {
  document.getElementById('f-title').value = data.title || '';
  document.getElementById('f-subtitle').value = (data.subtitle_lines || []).join('\n');
  document.getElementById('f-welcome').value = data.welcome_html || '';
  document.getElementById('f-author-name').value = data.author_name || '';
  document.getElementById('f-author-title').value = data.author_title || '';
  document.getElementById('f-author-url').value = data.author_url || 'https://parentdata.org/author/eoster/';
  document.getElementById('f-tags').value = (data.topic_tags || []).join(', ');
  document.getElementById('f-body').value = data.article_body_html || '';
  document.getElementById('f-bottomline').value = data.bottom_line_html || '';
  if (data.featured_image_url) document.getElementById('f-img-url').value = data.featured_image_url;
  if (data.featured_image_alt) document.getElementById('f-img-alt').value = data.featured_image_alt;
}

// Store qa_authors from upload response for use at generate time
let _qaAuthors = [];

function populateQAFields(data) {
  _qaAuthors = data.qa_authors || [];
  const qa1 = data.qa1 || {};
  document.getElementById('qa1-question').value = qa1.question_text || '';
  document.getElementById('qa1-author').value = qa1.question_author || '';
  document.getElementById('qa1-answer').value = qa1.answer_html || '';
  const qa2 = data.qa2 || {};
  document.getElementById('qa2-question').value = qa2.question_text || '';
  document.getElementById('qa2-author').value = qa2.question_author || '';
  document.getElementById('qa2-answer').value = qa2.answer_html || '';

  // Pre-populate editable attribution line from fetched author names
  const authors = _qaAuthors;
  let authorLine = '';
  if (authors.length === 1) {
    authorLine = `Today\u2019s answers come from ${authors[0]}.`;
  } else if (authors.length >= 2) {
    authorLine = `Today\u2019s answers come from ${authors.slice(0, -1).join(', ')} and ${authors[authors.length - 1]}.`;
  }
  document.getElementById('qa-author-line').value = authorLine;
}

function populateDigestFields(data) {
  document.getElementById('digest-title').value = data.title || '';
  document.getElementById('digest-intro').value = data.intro_text || '';
  buildDigestCards(data.articles || []);
}

function populateLatestTeaserFields(data) {
  ltArticleBodyHtml = data.article_body_html || '';
  document.getElementById('lt-title').value = data.title || '';
  document.getElementById('lt-subtitle').value = (data.subtitle_lines || []).join('\n');
  document.getElementById('lt-intro').value = data.intro_text || LT_DEFAULT_INTRO;
  document.getElementById('lt-fade-from').value = data.fade_from || '';
  document.getElementById('lt-img-url').value = data.featured_image_url || '';
  document.getElementById('lt-img-alt').value = data.featured_image_alt || '';
  document.getElementById('lt-article-url').value = data.article_url || '';
  fetchRelatedArticles(data.topic_tags || [], data.related_articles || []);
}

function buildDigestCards(articles) {
  const container = document.getElementById('digest-cards');
  container.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const art = articles[i - 1] || {};
    container.insertAdjacentHTML('beforeend', `
      <div class="digest-card-slot" style="border-top:1px solid #e0e0e0;margin-top:20px;padding-top:16px;">
        <h3>Article ${i}</h3>
        <div class="field-group">
          <label for="digest-art-title-${i}">Title</label>
          <input type="text" id="digest-art-title-${i}" value="${_esc(art.title || '')}" placeholder="Article title">
        </div>
        <div class="field-group">
          <label for="digest-art-url-${i}">URL</label>
          <input type="url" id="digest-art-url-${i}" value="${_esc(art.url || '')}" placeholder="https://parentdata.org/…">
        </div>
        <div class="field-group">
          <label for="digest-art-desc-${i}">Description</label>
          <textarea id="digest-art-desc-${i}" rows="2" style="width:100%;">${_esc(art.description || '')}</textarea>
        </div>
        <div class="field-group image-url-field">
          <label for="digest-art-img-${i}">Image URL${art.image_url ? ' <span style="font-weight:400;color:#2a7a2a;">(auto-fetched)</span>' : ' <span class="required">*</span>'}</label>
          <input type="url" id="digest-art-img-${i}" value="${_esc(art.image_url || '')}" placeholder="https://parentdata.org/wp-content/uploads/…">
        </div>
      </div>
    `);
  }
}

function populatePaidDigestFields(data) {
  buildPaidDigestSections(data.sections || []);
}

function buildPaidDigestSections(sections) {
  const container = document.getElementById('paid-digest-sections');
  container.innerHTML = '';
  _paidDigestStructure = sections.map(s => ({ articleCount: (s.articles || []).length }));
  let cardIndex = 0;
  for (let s = 0; s < sections.length; s++) {
    const section = sections[s];
    const articles = section.articles || [];
    container.insertAdjacentHTML('beforeend', `
      <div style="border-top:1px solid #e0e0e0;margin-top:20px;padding-top:16px;">
        <h3 style="margin:0 0 12px 0;">Section ${s + 1}</h3>
        <div class="field-group">
          <label for="pd-section-name-${s}">Section Name</label>
          <input type="text" id="pd-section-name-${s}" value="${_esc(section.name || '')}" placeholder="e.g. Popular this week">
        </div>
      </div>
    `);
    for (let a = 0; a < articles.length; a++) {
      const art = articles[a];
      container.insertAdjacentHTML('beforeend', `
        <div style="margin-left:20px;padding-top:8px;border-left:3px solid #e0e0e0;padding-left:16px;margin-bottom:12px;">
          <h4 style="margin:0 0 8px 0;">Article ${cardIndex + 1}</h4>
          <div class="field-group">
            <label for="pd-art-title-${cardIndex}">Title</label>
            <input type="text" id="pd-art-title-${cardIndex}" value="${_esc(art.title || '')}" placeholder="Article title">
          </div>
          <div class="field-group">
            <label for="pd-art-subtitle-${cardIndex}">Subtitle</label>
            <input type="text" id="pd-art-subtitle-${cardIndex}" value="${_esc(art.subtitle || '')}" placeholder="Article subtitle">
          </div>
          <div class="field-group">
            <label for="pd-art-url-${cardIndex}">URL</label>
            <input type="url" id="pd-art-url-${cardIndex}" value="${_esc(art.url || '')}" placeholder="https://parentdata.org/…">
          </div>
          <div class="field-group image-url-field">
            <label for="pd-art-img-${cardIndex}">Image URL${art.image_url ? ' <span style="font-weight:400;color:#2a7a2a;">(auto-fetched)</span>' : ''}</label>
            <input type="url" id="pd-art-img-${cardIndex}" value="${_esc(art.image_url || '')}" placeholder="https://parentdata.org/wp-content/uploads/…">
          </div>
          <div class="field-group">
            <label for="pd-art-imgalt-${cardIndex}">Image Alt</label>
            <input type="text" id="pd-art-imgalt-${cardIndex}" value="${_esc(art.image_alt || art.title || '')}" placeholder="Brief image description">
          </div>
        </div>
      `);
      cardIndex++;
    }
  }
}

function _esc(str) {
  return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Related Articles ────────────────────────────────────────────────────────
async function fetchRelatedArticles(tags, prefilledArticles = []) {
  const loadingEl = document.getElementById('related-loading');
  loadingEl.textContent = prefilledArticles.length > 0
    ? 'Loading article index for swap options…'
    : 'Fetching article suggestions…';
  loadingEl.removeAttribute('hidden');
  document.getElementById('related-cache-info').textContent = '';

  if (prefilledArticles.length > 0) {
    populateSlot(0, prefilledArticles[0] || {});
    populateSlot(1, prefilledArticles[1] || {});
  }

  const params = new URLSearchParams();
  tags.forEach(t => params.append('tags', t));

  try {
    const resp = await fetch(`/articles?${params}`);
    const data = await resp.json();
    allSuggestions = data.suggestions || data || [];
    _showCacheInfo(data.cache);
  } catch (e) {
    allSuggestions = [];
  }

  loadingEl.setAttribute('hidden', '');

  if (prefilledArticles.length === 0) {
    populateSlot(0, allSuggestions[0] || {});
    populateSlot(1, allSuggestions[1] || {});
  }

  populateSwapDropdowns();
}

function _showCacheInfo(cache) {
  const el = document.getElementById('related-cache-info');
  if (!cache || !cache.cached) { el.textContent = ''; return; }
  const age = cache.age_hours < 1 ? 'just fetched' : `${cache.age_hours}h old`;
  el.innerHTML =
    `Searching ${cache.article_count} articles (index ${age}). ` +
    `<button type="button" class="link-btn" onclick="refreshArticleIndex()">Refresh index</button>`;
}

async function refreshArticleIndex() {
  const el = document.getElementById('related-cache-info');
  el.textContent = 'Refreshing article index… (this may take 30–60 seconds)';
  try {
    const resp = await fetch('/refresh-articles', { method: 'POST' });
    const data = await resp.json();
    el.textContent = `Index refreshed — ${data.article_count} articles loaded.`;
  } catch (e) {
    el.textContent = `Refresh failed: ${e.message}`;
  }
}

function populateSlot(slotIndex, article) {
  slotData[slotIndex] = article;
  document.getElementById(`rel-${slotIndex}-title`).value = article.title || '';
  document.getElementById(`rel-${slotIndex}-url`).value = article.url || '';
  document.getElementById(`rel-${slotIndex}-image-url`).value = article.image_url || '';
  document.getElementById(`rel-${slotIndex}-image-alt`).value = article.image_alt || article.title || '';
  document.getElementById(`rel-${slotIndex}-description`).value = article.description || '';
}

function populateSwapDropdowns() {
  for (let slotIndex = 0; slotIndex < 2; slotIndex++) {
    const select = document.getElementById(`swap-${slotIndex}`);
    select.innerHTML = '<option value="">— select —</option>';
    allSuggestions.forEach((art, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = art.title || `Article ${i + 1}`;
      select.appendChild(opt);
    });
  }
}

function applySwap(slotIndex) {
  const select = document.getElementById(`swap-${slotIndex}`);
  const idx = parseInt(select.value);
  if (isNaN(idx) || !allSuggestions[idx]) return;
  populateSlot(slotIndex, allSuggestions[idx]);
  select.value = '';
}

// ── Generate ────────────────────────────────────────────────────────────────
async function generateEmail() {
  showStatus('generate-status', 'Building email HTML…', 'info');
  document.getElementById('result-links').setAttribute('hidden', '');

  const isQA = currentTemplate === 'qa';
  const isFertility = currentTemplate === 'fertility';
  const isMarketing = currentTemplate === 'marketing';
  const isDigest = currentTemplate === 'fertility_digest';
  const isLatestTeaser = currentTemplate === 'latest_teaser';
  const isPaidDigest = currentTemplate === 'paid_digest';

  let payload;

  if (isPaidDigest) {
    const sections = [];
    let cardIdx = 0;
    for (let s = 0; s < _paidDigestStructure.length; s++) {
      const name = document.getElementById(`pd-section-name-${s}`).value;
      const articles = [];
      const count = _paidDigestStructure[s].articleCount;
      for (let a = 0; a < count; a++) {
        articles.push({
          title:     document.getElementById(`pd-art-title-${cardIdx}`).value,
          subtitle:  document.getElementById(`pd-art-subtitle-${cardIdx}`).value,
          url:       document.getElementById(`pd-art-url-${cardIdx}`).value,
          image_url: document.getElementById(`pd-art-img-${cardIdx}`).value,
          image_alt: document.getElementById(`pd-art-imgalt-${cardIdx}`).value,
        });
        cardIdx++;
      }
      sections.push({ name, articles });
    }
    payload = {
      template_type: 'paid_digest',
      sections: sections,
    };
  } else if (isLatestTeaser) {
    const subtitleLines = document.getElementById('lt-subtitle').value
      .split('\n').map(s => s.trim()).filter(Boolean);
    const relatedArticles = [0, 1].map(i => ({
      title:       document.getElementById(`rel-${i}-title`).value,
      url:         document.getElementById(`rel-${i}-url`).value,
      image_url:   document.getElementById(`rel-${i}-image-url`).value,
      image_alt:   document.getElementById(`rel-${i}-image-alt`).value,
      description: document.getElementById(`rel-${i}-description`).value,
    })).filter(a => a.title || a.url);
    payload = {
      template_type:        'latest_teaser',
      title:                document.getElementById('lt-title').value,
      subtitle_lines:       subtitleLines,
      intro_text:           document.getElementById('lt-intro').value,
      fade_from:            document.getElementById('lt-fade-from').value,
      featured_image_url:   document.getElementById('lt-img-url').value,
      featured_image_alt:   document.getElementById('lt-img-alt').value,
      article_url:          document.getElementById('lt-article-url').value,
      article_body_html:    ltArticleBodyHtml,
      related_articles:     relatedArticles,
    };
  } else if (isDigest) {
    payload = {
      template_type: 'fertility_digest',
      title: document.getElementById('digest-title').value,
      intro_text: document.getElementById('digest-intro').value,
      articles: [1,2,3,4,5].map(i => ({
        title:       document.getElementById(`digest-art-title-${i}`).value,
        url:         document.getElementById(`digest-art-url-${i}`).value,
        description: document.getElementById(`digest-art-desc-${i}`).value,
        image_url:   document.getElementById(`digest-art-img-${i}`).value,
        image_alt:   document.getElementById(`digest-art-title-${i}`).value,
      })),
    };
  } else if (isQA) {
    payload = {
      template_type: 'qa',
      include_update_banner: document.getElementById('cb-update-banner').checked,
      intro_text: document.getElementById('qa-intro-text').value,
      qa_author_line: document.getElementById('qa-author-line').value,
      qa1: {
        question_text: document.getElementById('qa1-question').value,
        question_author: document.getElementById('qa1-author').value,
        answer_html: document.getElementById('qa1-answer').value,
      },
      qa2: {
        question_text: document.getElementById('qa2-question').value,
        question_author: document.getElementById('qa2-author').value,
        answer_html: document.getElementById('qa2-answer').value,
      },
    };
  } else if (isMarketing) {
    payload = {
      template_type: 'marketing',
      title: document.getElementById('f-title').value,
      author_name: document.getElementById('f-author-name').value,
      author_title: document.getElementById('f-author-title').value,
      author_url: document.getElementById('f-author-url').value,
      featured_image_url: document.getElementById('f-img-url').value,
      featured_image_alt: document.getElementById('f-img-alt').value,
      article_body_html: document.getElementById('f-body').value,
      banner_text: document.getElementById('mkt-banner').value,
      intro_option_text: document.getElementById('mkt-intro').selectedOptions[0]?.dataset.text || '',
      old_price: document.getElementById('mkt-mode-monthly').checked ? '$12' : '$120',
      discount_price: document.getElementById('mkt-price').value,
      discount_url: document.getElementById('mkt-url').value,
      article_url: uploadedArticleUrl,
    };
  } else {
    const subtitleLines = document.getElementById('f-subtitle').value
      .split('\n').map(s => s.trim()).filter(Boolean);
    const topicTags = document.getElementById('f-tags').value
      .split(',').map(s => s.trim()).filter(Boolean);
    const relatedArticles = isFertility ? [] : [0, 1].map(i => ({
      title: document.getElementById(`rel-${i}-title`).value,
      url: document.getElementById(`rel-${i}-url`).value,
      image_url: document.getElementById(`rel-${i}-image-url`).value,
      image_alt: document.getElementById(`rel-${i}-image-alt`).value,
      description: document.getElementById(`rel-${i}-description`).value,
    })).filter(a => a.title || a.url);

    const inlineGraphs = [];
    let gi = 1;
    while (document.getElementById(`graph-${gi}-url`)) {
      inlineGraphs.push({
        url: document.getElementById(`graph-${gi}-url`).value,
        alt: document.getElementById(`graph-${gi}-alt`).value,
      });
      gi++;
    }

    payload = {
      template_type: currentTemplate,
      include_update_banner: document.getElementById('cb-update-banner').checked,
      title: document.getElementById('f-title').value,
      subtitle_lines: subtitleLines,
      welcome_html: isFertility ? '' : document.getElementById('f-welcome').value,
      article_body_html: document.getElementById('f-body').value,
      bottom_line_html: isFertility ? document.getElementById('f-bottomline').value : '',
      author_name: document.getElementById('f-author-name').value,
      author_title: document.getElementById('f-author-title').value,
      author_url: document.getElementById('f-author-url').value,
      featured_image_url: document.getElementById('f-img-url').value,
      featured_image_alt: document.getElementById('f-img-alt').value,
      topic_tags: topicTags,
      related_articles: relatedArticles,
      inline_graphs: inlineGraphs,
    };
  }

  try {
    const resp = await fetch('/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ error: resp.statusText }));
      showStatus('generate-status', `Error: ${err.error || resp.statusText}`, 'error');
      return;
    }

    const htmlText = await resp.text();
    lastGeneratedHtml = htmlText;

    const blob = new Blob([htmlText], { type: 'text/html' });
    const blobUrl = URL.createObjectURL(blob);

    document.getElementById('preview-link').href = blobUrl;
    document.getElementById('download-link').href = blobUrl;
    document.getElementById('result-links').removeAttribute('hidden');

    showStatus('generate-status', 'Email generated! Open the preview, download, or copy the HTML.', 'success');

  } catch (err) {
    showStatus('generate-status', `Network error: ${err.message}`, 'error');
  }
}

// ── Inline graphs ────────────────────────────────────────────────────────────
function buildGraphFields(count, prefill = []) {
  const container = document.getElementById('graph-fields');
  container.innerHTML = '';
  for (let i = 1; i <= count; i++) {
    const pre = prefill[i - 1] || {};
    container.insertAdjacentHTML('beforeend', `
      <div class="graph-slot">
        <h3>Graph ${i}</h3>
        <div class="field-group image-url-field">
          <label>Image URL <span class="required">*</span></label>
          <input type="url" id="graph-${i}-url" value="${pre.url || ''}" placeholder="https://library.iterable.com/…">
        </div>
        <div class="field-group">
          <label>Alt text</label>
          <input type="text" id="graph-${i}-alt" value="${pre.alt || ''}" placeholder="e.g. Measles cases by week since 2022">
        </div>
      </div>
    `);
  }
}

// ── Copy HTML ────────────────────────────────────────────────────────────────
async function copyHtml() {
  if (!lastGeneratedHtml) return;
  try {
    await navigator.clipboard.writeText(lastGeneratedHtml);
    const btn = document.querySelector('#result-links button');
    const original = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = original; }, 2000);
  } catch (err) {
    alert('Copy failed — please use the Download button instead.\n\n' + err.message);
  }
}

// ── Marketing pricing mode ───────────────────────────────────────────────────
const _PRICING = {
  yearly:  { price: '$84/year',  url: 'https://parentdata.org/register/plus-yearly/?coupon=allaccess30' },
  monthly: { price: '$7/month',  url: 'https://parentdata.org/register/plus/?coupon=monthlydiscount' },
};
document.querySelectorAll('input[name="mkt-pricing-mode"]').forEach(radio => {
  radio.addEventListener('change', () => {
    const mode = document.querySelector('input[name="mkt-pricing-mode"]:checked').value;
    document.getElementById('mkt-price').value = _PRICING[mode].price;
    document.getElementById('mkt-url').value   = _PRICING[mode].url;
  });
});

// ── Marketing config ─────────────────────────────────────────────────────────
fetch('/marketing-config')
  .then(r => r.json())
  .then(data => {
    const sel = document.getElementById('mkt-intro');
    sel.innerHTML = '';
    (data.intro_options || []).forEach((opt, i) => {
      const o = document.createElement('option');
      o.value = opt.name;
      o.dataset.text = opt.text;
      o.textContent = opt.name;
      if (i === 0) o.selected = true;
      sel.appendChild(o);
    });
  })
  .catch(() => {});

// ── Utilities ───────────────────────────────────────────────────────────────
function showStatus(elId, message, type) {
  const el = document.getElementById(elId);
  el.textContent = message;
  el.className = `status-bar status-${type}`;
  el.removeAttribute('hidden');
}

// ── Initialise upload area for default template ─────────────────────────────
selectTemplate(currentTemplate);
</script>

</body>
</html>
